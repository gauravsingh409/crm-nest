datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  roles     UserRole[]
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  leads          Lead[]                @relation("LeadOwner")
  leadActivities LeadActivity[]        @relation("ActivityPerformer")
  profile        UserProfile?
  comments       LeadActivityComment[]
  followUps FollowUp[]
  appointments Appointment[]

  @@map("users")
}

model UserProfile {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  phone     String?
  profile   String?
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_profiles")
}

// Role and Permissions
model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  permissions RolePermission[]
  users       UserRole[]
}

model Permission {
  id    String           @id @default(uuid())
  name  String           @unique // delete_product
  roles RolePermission[]
}

model UserRole {
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id])
  role   Role   @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

// ======================== Leads Model ================================
enum LeadSource {
  WHATSAPP
  FACEBOOK
  INSTAGRAM
  YOUTUBE
  WEBSITE
  TIKTOK
  DOCTOR_REFERRAL
  SELF_CONTACT
  ADVERTISEMENT
  FRIENDS_FAMILY
  EXISTING_PATIENT
  TV
  RADIO
  OTHER
}

enum LeadCategory {
  FERTILITY_PATIENT
  NOT_FERTILITY_PATIENT
  SPAM_TEST_LEAD
  GYANEA_PATIENT
}

enum LeadService {
  IVF
  IUI
  EGG_FREEZING
  EMBRYO_FREEZING
  DONOR_PROGRAM_EGG
  DONOR_PROGRAM_SPERM
  PGT_PGD
  TESA_PESA
  ANTENATAL_CHECKUP
  INFERTILITY_DIAGNOSIS_GENERAL_COUNSELLING
  GYANEA
  FERTILITY_PRESERVATION
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  DISQUALIFIED
  CONVERTED
}

model Lead {
  id             String         @id @default(cuid())
  firstName      String
  lastName       String
  phone          String
  email          String?
  whatsapp       String?
  categories     LeadCategory
  service        LeadService
  source         LeadSource
  status         LeadStatus     @default(NEW)
  ownerId        String?
  owner          User?          @relation("LeadOwner", fields: [ownerId], references: [id])
  address        String?
  dob            DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  description    String?
  leadActivities LeadActivity[]

  @@index([source])
  @@index([categories])
  @@index([service])
  @@index([status])
  @@index([ownerId])
  @@index([createdAt])
  @@map("leads")
  followUps FollowUp[]
  appointments Appointment[]
}

// ======================== Lead Activities ================================
enum ActivityType {
  CALL
}

enum CallOutcome {
  SUCCESS
  BUSY
  NO_RESPONSE
  FAILED
  WRONG_NUMBER
  RECEIVED_BY_FAMILY
}

model LeadActivity {
  id            String                @id @default(cuid())
  leadId        String
  type          ActivityType
  callOutcome   CallOutcome?
  durationSec   Int?
  notes         String?
  performedById String
  comments      LeadActivityComment[]
  performedBy   User                  @relation("ActivityPerformer", fields: [performedById], references: [id])
  lead          Lead                  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  createdAt     DateTime              @default(now())

  @@index([leadId])
  @@index([type])
  @@index([callOutcome])
  @@index([performedById])
  @@index([createdAt])
}

// ======================= Lead Activity Comment =======================
model LeadActivityComment {
  id             String       @id @default(cuid())
  leadActivityId String
  leadActivity   LeadActivity @relation(fields: [leadActivityId], references: [id], onDelete: Cascade)
  comment        String       @db.Text
  commentById    String
  commentBy      User         @relation(fields: [commentById], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([leadActivityId])
  @@index([commentById])
  @@index([createdAt])
  @@map("lead_activity_comments")
}
// ======================== Follow Up =====================================
model FollowUp{
  id String @id @default(cuid())
  date_time DateTime
  remainder DateTime
  assignee_id String
  title String
  lead_id String
  branch_id String
  doctor_id String
  service LeadService
  appointment_date_time DateTime

  lead Lead @relation(fields: [lead_id], references: [id], onDelete: Cascade)
  branch Branch @relation(fields: [branch_id], references: [id], onDelete: Cascade)
  doctor Doctor @relation(fields: [doctor_id], references: [id], onDelete: Cascade)
  assignee User @relation(fields: [assignee_id], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([lead_id])
  @@index([assignee_id])
  @@index([createdAt])
}

// ========================= Appointment =================================
model Appointment{
  id String @id @default(cuid())
  lead_id String
  branch_id String
  doctor_id String
  user_id String
  service LeadService
  appointment_date_time DateTime

  lead Lead @relation(fields: [lead_id], references: [id], onDelete: Cascade)
  branch Branch @relation(fields: [branch_id], references: [id], onDelete: Cascade)
  doctor Doctor @relation(fields: [doctor_id], references: [id], onDelete: Cascade)
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([lead_id])
  @@index([branch_id])
  @@index([doctor_id])
  @@index([createdAt])
}

// ======================== Branch Model ================================
model Branch {
  id          String   @id @default(cuid())
  name        String   @unique
  phone       String   @unique
  address     String
  description String?  @db.Text
  doctors     Doctor[]
  createdAt   DateTime @default(now())

  @@map("branch")
  followUps FollowUp[]
  appointments Appointment[]
}
// ======================== Doctor Model ================================
model Doctor {
  id        String   @id @default(cuid())
  name      String
  phone     String
  branchId  String
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([name])
  @@index([branchId])
  @@index([branchId, name])
  @@map("doctor")
  followUps FollowUp[]
  appointments Appointment[]
}
